---
title: "saber_11_auditoria_imputacion"
author: "JOHN JAIRO PRADO PIÑERES"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float:
      collapsed: false
    theme: cosmo
    code_folding: hide
  word_document:
    toc: true
    toc_depth: 2
editor_options:
  chunk_output_type: console
---


<style>

/* ---------------------------------------------------------
   TIPOGRAFÍA GENERAL
--------------------------------------------------------- */
body {
  background-color: #F8F9FA;       /* gris claro */
  color: #2A2A2A;                  /* gris oscuro, mejora lectura */
  font-family: "Segoe UI", Roboto, Arial, sans-serif; /* tipografías limpias */
  font-size: 16px;                 /* tamaño ideal para lectura */
  line-height: 1.6;                /* más respiración entre líneas */
  margin: 0;
  padding: 0 12px;
}

/* ---------------------------------------------------------
   ENCABEZADOS
--------------------------------------------------------- */
h1 {
  font-size: 28px;
  color: #003366;
  margin-top: 30px;
  margin-bottom: 12px;
  font-weight: 700;
}

h2 {
  font-size: 24px;
  color: #005999;
  margin-top: 24px;
  margin-bottom: 10px;
  font-weight: 600;
}

h3 {
  font-size: 20px;
  color: #0077B6;
  margin-top: 20px;
  margin-bottom: 8px;
  font-weight: 600;
}

/* ---------------------------------------------------------
   PÁRRAFOS
--------------------------------------------------------- */
p {
  font-size: 16px;
  margin-bottom: 14px;
}

/* ---------------------------------------------------------
   BLOQUES DE CÓDIGO
--------------------------------------------------------- */
pre code {
  font-family: "Consolas", "Courier New", monospace;
  font-size: 15px;
  background-color: #FAFAFA;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #E0E0E0;
  display: block;
  overflow-x: auto; /* evita desbordes */
  white-space: pre;
}

/* ---------------------------------------------------------
   TABLAS
--------------------------------------------------------- */
table {
  width: 100%;
  border-collapse: collapse;
  background-color: white;
  margin: 20px 0;
  font-size: 15px;
}

th, td {
  border: 1px solid #D3D3D3;
  padding: 8px 12px;
}

th {
  background-color: #EFEFEF;
  text-align: center;
  font-weight: 600;
}

tr:nth-child(even) {
  background-color: #F7F7F7; /* filas alternas, mejora lectura */
}

/* ---------------------------------------------------------
   LISTAS
--------------------------------------------------------- */
ul, ol {
  margin-left: 20px;
  margin-bottom: 16px;
  font-size: 16px;
}

</style>

```{r limpiar entorno, echo =FALSE}
rm(list = ls()) # Se utiliza para borrar todos los objetos del espacio de trabajo.
graphics.off() # Se utiliza para cerrar todas las ventanas gráficas abiertas.
cat("\014") #Limpiar consola

```

```{r setup, include=FALSE}
library(knitr)

# Configuración global de chunks
opts_chunk$set(
  results = "markup",    # Mostrar resultados (comportamiento estándar)
  comment = "",          # No agrega '##' antes de cada línea de salida
  tidy = FALSE,          # No re-formatea el código automáticamente
  fig.align = "center",  # Centrar gráficos
  fig.width = 7,         # Tamaño estándar de figuras
  fig.height = 5
)

# Evitar notación científica
options(scipen = 999)
```

```{r}
options(repos = c(CRAN = "https://cloud.r-project.org"))

```

```{r}
# Instalar (solo la primera vez)
install.packages('tidyverse') # dplyr 1.1.4, readr 2.1.5, forcats 1.0.0, stringr 1.5.2, ggplot2 4.0.0, tibble 3.3.0, lubridate 1.9.4, tidyr 1.3.1, purrr 1.1.0 
install.packages('mice')
install.packages('VIM')
install.packages('tidyr')
install.packages('writexl')
install.packages('MASS')
install.packages('openxlsx')
install.packages('stringi')
install.packages('janitor')

```

# **FASE 1: CARGAR LIBRERÍAS**

```{r}

library(tidyverse)
library(mice)
library(VIM)
library(tidyr)
library(readr)
library(writexl)
library(MASS, exclude = "select")   # evita conflicto con dplyr::select
library(openxlsx)
library(stringi)
library(janitor)
library(lubridate)
library(forcats)

```

# **Razonamiento del Uso de Datos Post-2014 en la Predicción Global**

![](C:/Users/john/Desktop/Saber_11_2025/image/CambioMetodologia.jpg){width=80%}


# **PIPELINE DE PROCESAMIENTO E IMPUTACIÓN — SABER 11 (AÑO 2016)**


# **1. Función para la exploración preliminar de valores únicos**

```{r}
verificar_unicos <- function(df, max_mostrar = 20) {
  map_df(names(df), function(v) {
    tibble(
      variable = v,
      tipo = class(df[[v]])[1],
      n_unicos = length(unique(df[[v]])),
      muestra = paste(head(unique(df[[v]]), max_mostrar), collapse = ", ")
    )
  })
}

```

# **2. Función de limpieza profesional del dataset SABER 11 (2016)**

```{r}
limpiar_saber11 <- function(df) {

  df %>%
    # Selección de variables oficiales
    select(
      PERIODO, ANIO,
      COLE_COD_DANE_ESTABLECIMIENTO, COLE_COD_DANE_SEDE,
      PUNT_INGLES, PUNT_MATEMATICAS, PUNT_SOCIALES_CIUDADANAS,
      PUNT_C_NATURALES, PUNT_LECTURA_CRITICA, PUNT_GLOBAL,
      COLE_SEDE_PRINCIPAL, ESTU_PRIVADO_LIBERTAD,
      FAMI_TIENEAUTOMOVIL, FAMI_TIENECOMPUTADOR,
      FAMI_TIENEINTERNET, FAMI_TIENELAVADORA,
      COLE_BILINGUE,
      FAMI_CUARTOSHOGAR, FAMI_PERSONASHOGAR,
      FAMI_EDUCACIONMADRE, FAMI_EDUCACIONPADRE,
      FAMI_ESTRATOVIVIENDA, DESEMP_INGLES,
      COLE_AREA_UBICACION, COLE_DEPTO_UBICACION,
      COLE_MCPIO_UBICACION, COLE_NATURALEZA,
      COLE_GENERO, COLE_JORNADA,
      ESTU_DEPTO_PRESENTACION, ESTU_MCPIO_PRESENTACION,
      ESTU_GENERO
    ) %>%

    # Conversión de puntajes a numéricos
    mutate(across(starts_with("PUNT_"), as.numeric)) %>%

    # Recodificación de variables binarias
    mutate(across(
      c(COLE_SEDE_PRINCIPAL, ESTU_PRIVADO_LIBERTAD,
        FAMI_TIENEAUTOMOVIL, FAMI_TIENECOMPUTADOR,
        FAMI_TIENEINTERNET, FAMI_TIENELAVADORA, COLE_BILINGUE),
      ~ recode(.x,
        "Si"="Sí","SI"="Sí","S"="Sí","1"="Sí",
        "No"="No","NO"="No","N"="No","0"="No")
    )) %>%

    mutate(across(
      c(COLE_SEDE_PRINCIPAL, ESTU_PRIVADO_LIBERTAD,
        FAMI_TIENEAUTOMOVIL, FAMI_TIENECOMPUTADOR,
        FAMI_TIENEINTERNET, FAMI_TIENELAVADORA, COLE_BILINGUE),
      factor, levels = c("No", "Sí")
    )) %>%

    # Tratamiento de factores ordinales
    mutate(
      FAMI_CUARTOSHOGAR = recode(FAMI_CUARTOSHOGAR,
        "Cuatro"="Cuatro o más", "Cinco"="Cuatro o más"),
      FAMI_PERSONASHOGAR = recode(FAMI_PERSONASHOGAR,
        "Cinco"="Cinco o más"),

      FAMI_CUARTOSHOGAR = factor(FAMI_CUARTOSHOGAR,
        levels=c("Uno","Dos","Tres","Cuatro o más"), ordered=TRUE),

      FAMI_PERSONASHOGAR = factor(FAMI_PERSONASHOGAR,
        levels=c("Dos","Tres","Cuatro","Cinco o más"), ordered=TRUE),

      FAMI_EDUCACIONMADRE = factor(FAMI_EDUCACIONMADRE, ordered = TRUE),
      FAMI_EDUCACIONPADRE = factor(FAMI_EDUCACIONPADRE, ordered = TRUE),
      FAMI_ESTRATOVIVIENDA = factor(FAMI_ESTRATOVIVIENDA, ordered = TRUE),

      DESEMP_INGLES = factor(DESEMP_INGLES,
        levels=c("A-","A1","A2","B1","B+"), ordered = TRUE)
    ) %>%

    # Conversión de variables nominales a factor
    mutate(across(
      c(COLE_AREA_UBICACION, COLE_DEPTO_UBICACION,
        COLE_MCPIO_UBICACION, COLE_NATURALEZA,
        COLE_GENERO, COLE_JORNADA,
        ESTU_DEPTO_PRESENTACION, ESTU_MCPIO_PRESENTACION,
        ESTU_GENERO),
      factor
    ))
}

```


# **3. Carga del dataset SABER 11 — Año 2016**

```{r}
saber11_2016 <- read_csv(
  "C:/Users/john/Desktop/Saber_11_2025/data/2_sinDuplicados/saber11_2016_limpio.csv"
)

cat("\nVALORES ÚNICOS ANTES DE LIMPIAR (2016):\n")
print(verificar_unicos(saber11_2016), n=Inf)

```

# **4. Aplicación del proceso de limpieza**

```{r}

clean_2016 <- limpiar_saber11(saber11_2016)

cat("\nVALORES ÚNICOS DESPUÉS DE LIMPIAR (2016):\n")
print(verificar_unicos(clean_2016), n=Inf)

```



# **5. Análisis exploratorio de valores nulos**

```{r}
resumen_nulos_2016 <- clean_2016 %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
               names_to = "Variable",
               values_to = "Nulos") %>%
  mutate(Porcentaje = round((Nulos / nrow(clean_2016)) * 100, 3)) %>%
  arrange(desc(Nulos))

cat("\nRESUMEN DE NULOS (2016):\n")
print(resumen_nulos_2016, n=Inf)
```


# **6. Imputación MICE — Fase 1 (Año 2016)**

```{r}
vars_fase1 <- c(
  "FAMI_PERSONASHOGAR",
  "COLE_BILINGUE",
  "FAMI_CUARTOSHOGAR",
  "PUNT_INGLES","PUNT_MATEMATICAS","PUNT_SOCIALES_CIUDADANAS",
  "PUNT_C_NATURALES","PUNT_LECTURA_CRITICA","PUNT_GLOBAL",
  "PERIODO","ANIO"
)

mice_fase1_2016 <- clean_2016 %>% select(all_of(vars_fase1))

metodos1_2016 <- make.method(mice_fase1_2016)
metodos1_2016[c("FAMI_PERSONASHOGAR","FAMI_CUARTOSHOGAR")] <- "polr"
metodos1_2016["COLE_BILINGUE"] <- "logreg"
metodos1_2016[c("PERIODO","ANIO")] <- ""

pred1_2016 <- make.predictorMatrix(mice_fase1_2016)
pred1_2016[, c("PERIODO","ANIO")] <- 0
pred1_2016[c("PERIODO","ANIO"),] <- 0

imp_fase1_2016 <- mice(
  mice_fase1_2016,
  m = 5, maxit = 10,
  method = metodos1_2016,
  predictorMatrix = pred1_2016,
  seed = 5477976
)

saveRDS(imp_fase1_2016, "imp_fase1_2016.rds")
base2016 <- complete(imp_fase1_2016, 1)

```


# **7. Imputación MICE — Fase 2 (Año 2016)**

```{r}

base2016$FAMI_TIENEAUTOMOVIL  <- clean_2016$FAMI_TIENEAUTOMOVIL
base2016$FAMI_TIENECOMPUTADOR <- clean_2016$FAMI_TIENECOMPUTADOR
base2016$FAMI_TIENEINTERNET   <- clean_2016$FAMI_TIENEINTERNET
base2016$FAMI_TIENELAVADORA   <- clean_2016$FAMI_TIENELAVADORA
base2016$FAMI_ESTRATOVIVIENDA <- clean_2016$FAMI_ESTRATOVIVIENDA
base2016$FAMI_EDUCACIONMADRE  <- clean_2016$FAMI_EDUCACIONMADRE
base2016$FAMI_EDUCACIONPADRE  <- clean_2016$FAMI_EDUCACIONPADRE

# Variables utilizadas en Fase 2
vars_fase2 <- c(
  "FAMI_TIENEAUTOMOVIL","FAMI_TIENECOMPUTADOR","FAMI_TIENEINTERNET",
  "FAMI_TIENELAVADORA","FAMI_ESTRATOVIVIENDA",
  "FAMI_EDUCACIONMADRE","FAMI_EDUCACIONPADRE",
  "FAMI_PERSONASHOGAR","COLE_BILINGUE","FAMI_CUARTOSHOGAR",
  "PUNT_INGLES","PUNT_MATEMATICAS","PUNT_SOCIALES_CIUDADANAS",
  "PUNT_C_NATURALES","PUNT_LECTURA_CRITICA","PUNT_GLOBAL",
  "PERIODO","ANIO"
)

mice_fase2_2016 <- base2016 %>% select(all_of(vars_fase2))

metodos2_2016 <- make.method(mice_fase2_2016)
metodos2_2016[c("FAMI_ESTRATOVIVIENDA","FAMI_EDUCACIONMADRE",
  "FAMI_EDUCACIONPADRE","FAMI_PERSONASHOGAR","FAMI_CUARTOSHOGAR")] <- "polr"

metodos2_2016[c("FAMI_TIENEAUTOMOVIL","FAMI_TIENECOMPUTADOR",
  "FAMI_TIENEINTERNET","FAMI_TIENELAVADORA","COLE_BILINGUE")] <- "logreg"

metodos2_2016[c("PERIODO","ANIO")] <- ""

pred2_2016 <- make.predictorMatrix(mice_fase2_2016)
pred2_2016[, c("PERIODO","ANIO")] <- 0
diag(pred2_2016) <- 0

# Ejecución de Fase 2
imp_fase2_2016 <- mice(
  mice_fase2_2016,
  m = 5, maxit = 10,
  method = metodos2_2016,
  predictorMatrix = pred2_2016,
  seed = 5477976
)

saveRDS(imp_fase2_2016, "imp_fase2_2016.rds")

```


# **8. Exportación de las 5 bases imputadas**

```{r}
ruta2016 <- "C:/Users/john/Desktop/Saber_11_2025/data/DB_imp_2016/"
dir.create(ruta2016, recursive = TRUE, showWarnings = FALSE)

for(i in 1:5){
  df_imp <- complete(imp_fase2_2016, i)

  saveRDS(df_imp, paste0(ruta2016, "imp2016_db", i, ".rds"))
  write.csv(df_imp, paste0(ruta2016, "imp2016_db", i, ".csv"), row.names = FALSE)
  write.xlsx(df_imp, paste0(ruta2016, "imp2016_db", i, ".xlsx"), overwrite = TRUE)

  cat("Exportada imp2016_db", i, "\n")
}

```


# **9. Carga automática de las bases para evaluación**

```{r}
imp2016_list <- list()

for(i in 1:5){
  archivo <- paste0(ruta2016, "imp2016_db", i, ".csv")
  imp2016_list[[i]] <- read_csv(archivo, show_col_types = FALSE)
}

names(imp2016_list) <- paste0("imp2016_db", 1:5)

```


# **10. Función profesional para el resumen de nulos**

```{r}
resumen_nulos_fun <- function(df){
  df %>%
    summarise(across(everything(), ~ sum(is.na(.)))) %>%
    pivot_longer(cols = everything(),
                 names_to = "Variable",
                 values_to = "Nulos") %>%
    mutate(Porcentaje = round((Nulos / nrow(df)) * 100, 4)) %>%
    arrange(desc(Nulos))
}
```


# **11. Validación de nulos y número de columnas**

```{r}
for(i in 1:5){
  df <- imp2016_list[[i]]

  cat("\n--- RESUMEN DE NULOS — imp2016_db", i, " ---\n", sep="")
  cat("Número de variables:", ncol(df), "\n")
  print(resumen_nulos_fun(df), n=Inf)
}
```


# **12. Imputación adicional mediante MODA (si aplica)**

```{r}
# Función de imputación por moda:
imputar_moda <- function(x){
  ux <- unique(x[!is.na(x)])
  ux[which.max(tabulate(match(x, ux)))]
}

# Aplicación sobre la variable ESTU_GENERO
for(i in 1:5){
  df <- imp2016_list[[i]]
  moda_genero <- imputar_moda(df$ESTU_GENERO)
  df$ESTU_GENERO[is.na(df$ESTU_GENERO)] <- moda_genero
  imp2016_list[[i]] <- df

  cat("Imputado ESTU_GENERO en imp2016_db", i, " | moda:", moda_genero, "\n")
}
```


# **13. Exportación final de las 5 bases con las 32 variables completas**

```{r}
for(i in 1:5){
  df <- imp2016_list[[i]]

  write.csv(df, paste0(ruta2016, "imp2016_db", i, ".csv"), row.names = FALSE)
  write.xlsx(df, paste0(ruta2016, "imp2016_db", i, ".xlsx"), overwrite = TRUE)
  saveRDS(df, paste0(ruta2016, "imp2016_db", i, ".rds"))

  cat("Exportadas imp2016_db", i, " en csv, xlsx y rds.\n")
}

cat("\nEXPORTACIÓN COMPLETA.\n")
```

