---
title: "saber_11_auditoria_imputacion"
author: "JOHN JAIRO PRADO PIÑERES"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float:
      collapsed: false
    theme: cosmo
    code_folding: hide
  word_document:
    toc: true
    toc_depth: 2
editor_options:
  chunk_output_type: console
---


<style>

/* ---------------------------------------------------------
   TIPOGRAFÍA GENERAL
--------------------------------------------------------- */
body {
  background-color: #F8F9FA;       /* gris claro */
  color: #2A2A2A;                  /* gris oscuro, mejora lectura */
  font-family: "Segoe UI", Roboto, Arial, sans-serif; /* tipografías limpias */
  font-size: 16px;                 /* tamaño ideal para lectura */
  line-height: 1.6;                /* más respiración entre líneas */
  margin: 0;
  padding: 0 12px;
}

/* ---------------------------------------------------------
   ENCABEZADOS
--------------------------------------------------------- */
h1 {
  font-size: 28px;
  color: #003366;
  margin-top: 30px;
  margin-bottom: 12px;
  font-weight: 700;
}

h2 {
  font-size: 24px;
  color: #005999;
  margin-top: 24px;
  margin-bottom: 10px;
  font-weight: 600;
}

h3 {
  font-size: 20px;
  color: #0077B6;
  margin-top: 20px;
  margin-bottom: 8px;
  font-weight: 600;
}

/* ---------------------------------------------------------
   PÁRRAFOS
--------------------------------------------------------- */
p {
  font-size: 16px;
  margin-bottom: 14px;
}

/* ---------------------------------------------------------
   BLOQUES DE CÓDIGO
--------------------------------------------------------- */
pre code {
  font-family: "Consolas", "Courier New", monospace;
  font-size: 15px;
  background-color: #FAFAFA;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #E0E0E0;
  display: block;
  overflow-x: auto; /* evita desbordes */
  white-space: pre;
}

/* ---------------------------------------------------------
   TABLAS
--------------------------------------------------------- */
table {
  width: 100%;
  border-collapse: collapse;
  background-color: white;
  margin: 20px 0;
  font-size: 15px;
}

th, td {
  border: 1px solid #D3D3D3;
  padding: 8px 12px;
}

th {
  background-color: #EFEFEF;
  text-align: center;
  font-weight: 600;
}

tr:nth-child(even) {
  background-color: #F7F7F7; /* filas alternas, mejora lectura */
}

/* ---------------------------------------------------------
   LISTAS
--------------------------------------------------------- */
ul, ol {
  margin-left: 20px;
  margin-bottom: 16px;
  font-size: 16px;
}

</style>

```{r limpiar entorno, echo =FALSE}
rm(list = ls()) # Se utiliza para borrar todos los objetos del espacio de trabajo.
graphics.off() # Se utiliza para cerrar todas las ventanas gráficas abiertas.
cat("\014") #Limpiar consola

```

```{r setup, include=FALSE}
library(knitr)

# Configuración global de chunks
opts_chunk$set(
  results = "markup",    # Mostrar resultados (comportamiento estándar)
  comment = "",          # No agrega '##' antes de cada línea de salida
  tidy = FALSE,          # No re-formatea el código automáticamente
  fig.align = "center",  # Centrar gráficos
  fig.width = 7,         # Tamaño estándar de figuras
  fig.height = 5
)

# Evitar notación científica
options(scipen = 999)
```

```{r}
options(repos = c(CRAN = "https://cloud.r-project.org"))

```

```{r}
# Instalar (solo la primera vez)
install.packages('tidyverse') # dplyr 1.1.4, readr 2.1.5, forcats 1.0.0, stringr 1.5.2, ggplot2 4.0.0, tibble 3.3.0, lubridate 1.9.4, tidyr 1.3.1, purrr 1.1.0 
install.packages('mice')
install.packages('VIM')
install.packages('tidyr')
install.packages('writexl')
install.packages('MASS')
install.packages('openxlsx')
install.packages('stringi')
install.packages('janitor')

```

# **FASE 1: CARGAR LIBRERÍAS**

```{r}

library(tidyverse)
library(mice)
library(VIM)
library(tidyr)
library(readr)
library(writexl)
library(MASS, exclude = "select")   # evita conflicto con dplyr::select
library(openxlsx)
library(stringi)
library(janitor)
library(lubridate)
library(forcats)

```

# **Razonamiento del Uso de Datos Post-2014 en la Predicción Global**

![](C:/Users/john/Desktop/Saber_11_2025/image/CambioMetodologia.jpg){width=80%}

```{r}

# 1. Cargar datos originales

saber11_2022 <- read_csv(
  "C:/Users/john/Desktop/Saber_11_2025/data/2_sinDuplicados/saber11_2022_limpio.csv")

imp2022_db1 <- read_csv(
  "C:/Users/john/Desktop/Saber_11_2025/data/3_DB_imp/imp2022_db1.csv")

# 2. Eliminar PERIODO y ANIO del df imputado

imp2022_db1 <- imp2022_db1 %>% select(-PERIODO, -ANIO)

# 3. Añadir las 6 variables faltantes desde saber11_2022

faltantes_2022 <- saber11_2022 %>% 
  select(
    COLE_COD_DANE_ESTABLECIMIENTO,
    COLE_DEPTO_UBICACION,
    COLE_MCPIO_UBICACION,
    COLE_NATURALEZA,
    COLE_GENERO,
    COLE_JORNADA
  )

imp2022_db1 <- bind_cols(imp2022_db1, faltantes_2022)

# 4. Eliminar registros con NA en llaves institucionales

imp2022_db1 <- imp2022_db1 %>%
  filter(
    !is.na(COLE_COD_DANE_ESTABLECIMIENTO),
    !is.na(COLE_DEPTO_UBICACION),
    !is.na(COLE_MCPIO_UBICACION)
  )


# 5. Imputación por Moda para 3 variables

moda <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

imp2022_db1$COLE_NATURALEZA[is.na(imp2022_db1$COLE_NATURALEZA)] <- moda(imp2022_db1$COLE_NATURALEZA)
imp2022_db1$COLE_GENERO[is.na(imp2022_db1$COLE_GENERO)]         <- moda(imp2022_db1$COLE_GENERO)
imp2022_db1$COLE_JORNADA[is.na(imp2022_db1$COLE_JORNADA)]       <- moda(imp2022_db1$COLE_JORNADA)

# 6. VARIABLES A IMPUTAR DE FORMA INDIVIDUAL (MICE)

vars_mice_2022 <- c(
  "COLE_BILINGUE",
  "FAMI_TIENEINTERNET",
  "FAMI_TIENEAUTOMOVIL",
  "FAMI_TIENELAVADORA",
  "FAMI_TIENECOMPUTADOR"
)

# Normalizar factores
imp2022_db1 <- imp2022_db1 %>%
  mutate(
    COLE_BILINGUE        = recode(COLE_BILINGUE, "N"="No","S"="Sí"),
    FAMI_TIENEINTERNET   = recode(FAMI_TIENEINTERNET, "N"="No","S"="Sí"),
    FAMI_TIENEAUTOMOVIL  = recode(FAMI_TIENEAUTOMOVIL, "N"="No","S"="Sí"),
    FAMI_TIENELAVADORA   = recode(FAMI_TIENELAVADORA, "N"="No","S"="Sí"),
    FAMI_TIENECOMPUTADOR = recode(FAMI_TIENECOMPUTADOR, "N"="No","S"="Sí")
  ) %>%
  mutate(
    COLE_BILINGUE        = factor(COLE_BILINGUE, levels=c("No","Sí")),
    FAMI_TIENEINTERNET   = factor(FAMI_TIENEINTERNET, levels=c("No","Sí")),
    FAMI_TIENEAUTOMOVIL  = factor(FAMI_TIENEAUTOMOVIL, levels=c("No","Sí")),
    FAMI_TIENELAVADORA   = factor(FAMI_TIENELAVADORA, levels=c("No","Sí")),
    FAMI_TIENECOMPUTADOR = factor(FAMI_TIENECOMPUTADOR, levels=c("No","Sí"))
  )

# predictores fuertes
pred_acad_2022 <- c(
  "PUNT_INGLES","PUNT_MATEMATICAS","PUNT_SOCIALES_CIUDADANAS",
  "PUNT_C_NATURALES","PUNT_LECTURA_CRITICA","PUNT_GLOBAL"
)


# 7. FUNCIÓN GENERAL PARA IMPUTACIÓN BINARIA (MICE)

imputar_binaria_2022 <- function(df, variable) {

  cat("IMPUTANDO:", variable, "\n")

  df_imp <- df %>% select(all_of(variable), all_of(pred_acad_2022))

  set.seed(5477976)
  ini <- mice(df_imp, maxit=0, print=FALSE)

  meth <- ini$method
  meth[] <- ""
  meth[variable] <- "logreg"

  pred <- ini$predictorMatrix
  pred[, variable] <- 1
  pred[variable, ] <- 0

  cat("\n--- ANTES DE IMPUTAR ---\n")
  print(table(df[[variable]], useNA="ifany"))

  imp_temp <- mice(df_imp, m=1, maxit=10, method=meth,
                   predictorMatrix=pred, seed=5477976, print=FALSE)

  df[[variable]] <- complete(imp_temp, 1)[[variable]]

  cat("\n--- DESPUÉS DE IMPUTAR ---\n")
  print(table(df[[variable]], useNA="ifany"))

  return(df)
}

# 8. IMPUTAR UNA POR UNA

imp2022_imputado <- imp2022_db1

for (v in vars_mice_2022) {
  imp2022_imputado <- imputar_binaria_2022(imp2022_imputado, v)
}

# 9. Verificación final

cat("\n=======================\nNULOS FINALES\n=======================\n")
print(colSums(is.na(imp2022_imputado)))

# 10. Exportación

ruta_export <- "C:/Users/john/Desktop/Saber_11_2025/data/3_DB_imp"

write_csv(imp2022_imputado, file.path(ruta_export, "imp2022_imputado.csv"))
write.xlsx(imp2022_imputado, file.path(ruta_export, "imp2022_imputado.xlsx"), overwrite=TRUE)

cat("\nArchivos exportados correctamente:\n")
cat("- imp2022_imputado.csv\n")
cat("- imp2022_imputado.xlsx\n")
```

